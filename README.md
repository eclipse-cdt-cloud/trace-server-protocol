# trace-server-protocol

Specification of the Trace Server Protocol (TSP).

The specification is currently written in **OpenAPI 3.0** and can be pretty-visualized in the [github pages][tspGhPages].

**ðŸ‘‹ Want to help?** Read our [contributor guide][contributing].

## About, why and goals of the TSP:

Similarly to the philosophy behind the Language Server Protocol (LSP),
the TSP is an open, HTTP-based protocol for use between *analytics or
interactive visualization web applications* and *servers that provide
trace analysis specific features* such as:

- generation of data that can interpeted as charts from trace analysis
- selection, filtering and correlation of elements in charts using data
  contained in the traces
- statistics calculation from data contained in the traces

The goal of the protocol is to allow trace analysis support to be
implemented and distributed independently of any given analytics or
interactive visualization web application.

## What the TSP is:

The TSP is a RESTful API on top of the HTTP protocol that enables to:

- analyze time series data (e.g. traces and logs);
- return the result of the analysis in form of data that represents
  *charts* or *charts components*;
- *navigate (or explore)* through the returned data;

Summarizing:

> the TSP is an API to explore data and navigate charts that has been
> generated from the interpretation of time series data.

With the term *chart* we mean different type of visualizations such as
XY charts, timegraph charts, tables, pie charts, etc.

With the term *chart components* we mean different elements that
can be used to build or enrich charts such as arrows, annotations,
bookmarks, etc.

With the terms *exploration and navigation* we mean interactions with
the charts, such as:

- **filter** specific components of the charts. For example:
  - remove from the chart all components that do not match a condition;
  - return components of the chart that do match a condition;
- **select** a subset of all data points of a chart. For example:
  - given a Timegraph chart, return only the data between a specific
    time interval
- **select** specific components of the charts. For example:
  - when analyzing the trace of a SW execution, select only some
    components of the chart that represent specific SW functions;
  - when analyzing the trace of a SW execution, select only some
    components of the chart executed on specific CPUs;
  - given a Timegraph chart, automatically select areas of the chart
    where the components match a specific condition (**zoom-on-crash-area**)
- **correlate** components between charts. For example:
  - given 2 charts generated by the analysis of the same time series data,
    it enables to correlate the chart components that represent the same
    information. For example, given a table containing the max length
    of an interval in a time chart, it enables to identify the corresponding
    interval in the time chart (**go-to-min/max**)
- **correlate** chart components and their information. For example:
  - given a interval in a time chart, extrapolate all information related
    to that interval (e.g. **source location**)
- **order** specific parts of the charts. For example:
  - return the **N longest** intervals of a timegraph chart;
- **customize** charts and charts components. For example:
  - given a table containing statistics from analysis of all input data,
    generate a new table containing statistics from analysis of a
	subset of the input data;
  - given a time chart where intervals represent thread execution over
    time, and they are connected using arrows, generate a new time chart
	showing the longest path of connected intervals (e.g. **critical path**)

## Guidelines for the TSP implementation

The main resources (endpoints) of the API should be:

- **data sources** (e.g. time series data such as traces and logs). These
  are analyzed and used to create the data that can be retrieved;
- **charts** (e.g. tables, XY charts), used to retrieve data representing
  a chart;
- **chart components** (e.g. annotations, styles), used to retrieve data
  representing specific information for a chart;

The *exploration and navigation* should be achieved by:

- parameters in the HTTP message body data (usually when POST-ing), or
  as query strings (usually when GET-ing). These parameters should be:
  - **data source related**. For example, considering that data sources
    have a strong relation to time, a classic parameter can be "time"
	related (e.g. *requested_timerange*);
  - **chart related**. For example, when "talking" to a resource representing
    an XY chart, a parameter can be related to "XY dimensions"	(e.g.
	*requested_Y_elements*);

## Current version

The current version of the specification is currently implemented and supported in the [Trace Compass trace-server][tcServer] (reference implementation) and what is currently supported by the [tsp-typescript-client][tspClient].

Swagger can be used to generate the API version implemented in Trace Compass trace-server (see [here](#generate-the-specification)).

## Future version

Some proposal for additional endpoints and features are documented in the `./API-proposed.yaml`. All the proposed changes are still not confirmed and can change. The pretty-visualized file can be found [here][apiProposed]. A diff of the current version and future version will show the differences.

Once an update has been approved it will be migrated to the main `./API.yaml` file.

## Update manually

The specification should be edited with the [OpenAPI (Swagger) Editor extension][vscodeOpenapi] for VS Code.

The latter extension is assumed for consistent formatting of the `./API-proposed.yaml` file over time.

## Generate the specification

### Setup

To initialize a local virtual environment, type the following commands in the root directory:

```shell
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

The virtual environment can be replaced with another local setup.

### Generate the API

Swagger has recently been added to the Trace Compass trace-server (reference implementation).

* Below is how to generate the TSP version, according to Swagger in trace-server.
* The generated TSP should match the current supported version of the TSP. Any differences may be pushed for review.
* `API.yaml` shows now the current supported version of the TSP.

1. Import all [TC][tracecompass] and [incubator][incubator] projects in Eclipse; branch, Target Platform and API Baseline set to `master`.
1. Open `traceserver.product` file in plug-in `org.eclipse.tracecompass.incubator.trace.server.product`.
1. Click on the `Run` button on the top right corner of the opened `traceserver.product`.
1. Browse [to here][apiyaml] ([swagger][swagger]) or so to generate server's TSP.
1. The resulting file is stored in the user's Downloads directory; e.g.: `~/Downloads/openapi.yaml`
1. Copy `~/Downloads/openapi.yaml` to this directory.
1. Update the latter with its license information and remove extra information: `./openapi.py`
1. The resulting diff between `API.yaml` and `openapi.yaml` can then be pushed for review.
   * Note, that the order of fields, components etc. might be different everytime the API is generated using swagger-core. This is due to how swagger-core is implemented.
1. Make sure to transfer the diffs to `API-proposed.yaml` as well.
1. `openapi.yaml` should not be merged to the repository and can be deleted when not needed anymore.

[apiProposed]: https://eclipse-cdt-cloud.github.io/trace-server-protocol/proposed/
[apiyaml]: http://localhost:8080/tsp/api/openapi.yaml
[contributing]: CONTRIBUTING.md
[incubator]: https://projects.eclipse.org/projects/tools.tracecompass.incubator/developer
[swagger]: https://github.com/swagger-api/swagger-core/wiki/Swagger-2.X---Integration-and-configuration#openapiresource
[tcServer]: https://download.eclipse.org/tracecompass.incubator/trace-server/rcp/
[tracecompass]: https://projects.eclipse.org/projects/tools.tracecompass/developer
[tspClient]: https://github.com/eclipse-cdt-cloud/tsp-typescript-client
[tspGhPages]: https://eclipse-cdt-cloud.github.io/trace-server-protocol/
[vscodeOpenapi]: https://marketplace.visualstudio.com/items?itemName=42Crunch.vscode-openapi
